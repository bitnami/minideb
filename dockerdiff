#!/bin/bash

set -e
set -u
set -o pipefail

IMAGE1=$1
IMAGE2=$2

inspect() {
    docker inspect $1 | jq ".[0]|del(.Id,.RepoTags,.RepoDigests,.Created)"
}

dpkgl() {
    docker run --rm $1 dpkg -l
}

lslr() {
    docker run --rm $1 bash -c 'find / -path /proc -prune -o -print0 | xargs -0 ls -ld'
}

if ! diff -u <(inspect $IMAGE1) <(inspect $IMAGE2); then
    diff -u <(dpkgl $IMAGE1) <(dpkgl $IMAGE2) || true
    diff -u <(lslr $IMAGE1) <(lslr $IMAGE2) || true
    exit 1
fi
